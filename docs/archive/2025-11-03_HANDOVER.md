# Handover: Deployment-Versuche vom 03.11.2025

## Ziel

Ziel war das Deployment des Projekts auf Google Cloud gemäß dem `ALPHA_DEPLOYMENT_PLAN.md`.

## Aktueller Status

- **Phase 1: Backend Deployment**: Erfolgreich abgeschlossen.
  - Das `dashboard-backend` läuft auf Cloud Run und ist unter der URL `https://dashboard-backend-6j45j5325a-ew.a.run.app` erreichbar.
  - Der Health-Check (`/api/health`) war erfolgreich.
- **Phase 2: Frontend Deployment**: Erfolgreich abgeschlossen.
  - Das Frontend wurde auf Firebase Hosting bereitgestellt und ist unter `https://true-campus-475614-p4.web.app` erreichbar.
- **Phase 3: Agent Deployment**: **Blockiert**.
  - Das Deployment des `ingestion-agent` schlägt wiederholt fehl. Der Container startet nicht in der Cloud Run-Umgebung.

## Detaillierte Chronik der `ingestion-agent`-Deployment-Versuche

Wir haben mehrere Iterationen durchlaufen, um das Deployment des `ingestion-agent` zu korrigieren. Hier ist eine Zusammenfassung der Probleme und der durchgeführten Lösungsversuche:

### Versuch 1: Initiales Deployment
- **Befehl**: `gcloud run deploy --source=./agents/ingestion-agent ...`
- **Problem**: Build-Fehler, da das `shared`-Verzeichnis außerhalb des Build-Kontexts lag.
- **Erkenntnis**: Der Build-Kontext muss das gesamte Projekt umfassen.

### Versuch 2: Anpassung des Build-Kontexts
- **Änderung**: `Dockerfile` angepasst, um das `shared`-Paket via `pip install .` zu installieren. `cloudbuild.yaml` erstellt, um den Build-Prozess zu steuern.
- **Problem**: `ImportError: cannot import name 'secretmanager' ...`. Eine Abhängigkeit (`google-cloud-secret-manager`) fehlte in der `setup.py`.
- **Erkenntnis**: Alle transitiven Abhängigkeiten müssen explizit deklariert werden.

### Versuch 3: Korrektur der Abhängigkeiten
- **Änderung**: `google-cloud-secret-manager` zur `setup.py` hinzugefügt.
- **Problem**: `ModuleNotFoundError: No module named 'vertexai.generative_models'`. Eine veraltete Version von `google-cloud-aiplatform` wurde aufgrund von Abhängigkeitskonflikten zwischen `requirements.txt` und `setup.py` installiert.
- **Erkenntnis**: Abhängigkeiten sollten nur an einer zentralen Stelle (der `setup.py` des `shared`-Pakets) verwaltet werden, um Konflikte zu vermeiden.

### Versuch 4: Bereinigung der `requirements.txt`
- **Änderung**: Alle redundanten Abhängigkeiten aus der `agents/ingestion-agent/requirements.txt` entfernt.
- **Problem**: `NameError: name 'field' is not defined`. Ein Python-Fehler in `shared/apis/data_fusion.py` (fehlender Import).
- **Erkenntnis**: Der Code selbst enthielt einen Fehler, der erst nach Lösung der Abhängigkeitsprobleme sichtbar wurde.

### Aktueller Stand (nach Versuch 5)
- **Änderung**: Der `NameError` in `data_fusion.py` wurde behoben.
- **Problem**: Das Deployment schlägt immer noch mit dem ursprünglichen Timeout-Fehler fehl: `The user-provided container failed to start and listen on the port...`.
- **Analyse**: Obwohl der Build-Prozess jetzt erfolgreich zu sein scheint und alle bekannten Code- und Abhängigkeitsfehler behoben sind, gibt es immer noch ein grundlegendes Problem, das den Start des Containers verhindert. Die Logs geben keinen neuen Aufschluss über die Ursache.

## Nächste empfohlene Schritte

1.  **Lokale Docker-Simulation**:
    - Versuche, das Docker-Image des `ingestion-agent` lokal zu bauen und auszuführen, um das Verhalten der Cloud-Umgebung zu simulieren.
    - Befehl zum Bauen: `docker build -t ingestion-agent-test -f agents/ingestion-agent/Dockerfile .`
    - Befehl zum Ausführen: `docker run -p 8080:8080 -e PORT=8080 ingestion-agent-test`
    - Dies wird wahrscheinlich den genauen Fehler zeigen, der den Start verhindert.

2.  **Überprüfung des Entrypoints**:
    - Das `Dockerfile` verwendet `CMD exec functions-framework --target=ingestion_analysis_agent --port=$PORT`. Es muss sichergestellt werden, dass die Funktion `ingestion_analysis_agent` in `main.py` korrekt definiert ist und keine Importfehler auf oberster Ebene mehr existieren, die den Start des Frameworks verhindern.

3.  **Minimale Test-Funktion**:
    - Erstelle eine temporäre, extrem einfache "Hello World"-Funktion in der `main.py` des Agenten und versuche, diese zu deployen. Wenn das funktioniert, liegt das Problem im Initialisierungscode der `ingestion_analysis_agent`-Funktion oder ihren Importen.

Ich hoffe, diese detaillierte Dokumentation hilft bei der weiteren Fehlersuche.