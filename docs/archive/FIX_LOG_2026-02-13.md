# Fix Log: 13.02.2026 - Critical Stability Updates

Dieses Dokument fasst die heute durchgeführten kritischen Reparaturen und Updates zusammen, die die Stabilität des Systems massiv verbessert haben.

## 1. Ingestion Parsing Robustheit (JSON Extraction)

**Problem:**
Die neueren Gemini-Modelle (2.0 Flash / 2.5) tendieren dazu, "gesprächiger" zu sein und liefern oft Markdown-Formatierungen (z.B. \`\`\`json ... \`\`\`) oder erklärenden Text um das JSON-Objekt herum. Dies führte dazu, dass der strikte JSON-Parser im `ingestion-agent` fehlschlug, obwohl die Daten eigentlich vorhanden waren.

**Lösung:**
Implementierung einer robusten "Fuzzy Extraction"-Logik in `shared/simplified_ingestion/core.py`.
*   **Regex-Extraction:** Das System sucht nun aktiv nach JSON-Codeblöcken im Markdown.
*   **Fallback-Suche:** Falls kein Codeblock gefunden wird, sucht ein Regex nach der Struktur `{ ... }`, um das JSON-Objekt aus dem Rohtext zu extrahieren.
*   **Confidence Normalization:** Normalisierung von Confidence-Scores (z.B. Umwandlung von Strings "95%" oder Integers 95 in Floats 0.95), um Schema-Validierungsfehler zu vermeiden.

## 2. Status Race Condition Fix

**Problem:**
Es gab eine Race Condition zwischen dem `ingestion-agent` und dem `condition-assessor`. Der `ingestion-agent` triggerte den `condition-assessor`, bevor der Status des Buch-Dokuments in Firestore korrekt auf `new` persistiert war. Der `condition-assessor` startete, fand aber noch den alten Status oder gar kein Dokument vor und brach ab oder verhielt sich unerwartet.

**Lösung:**
*   **Explizites Warten:** Der `ingestion-agent` wartet nun auf die Bestätigung der Firestore-Transaktion.
*   **Status-Check:** Vor dem Triggern des Folge-Agenten wird sichergestellt, dass der Status im Dokument tatsächlich aktualisiert wurde.

## 3. Trigger Mismatch (Cloud Build vs. Pub/Sub)

**Problem:**
Die Trigger-Konfiguration für den `ingestion-agent` war inkonsistent. Cloud Build erwartete teilweise andere Parameter oder Topic-Namen als die, die tatsächlich vom Upload-Event oder den manuellen Skripten gesendet wurden. Dies führte dazu, dass Agenten nicht starteten oder falsche Argumente erhielten.

**Lösung:**
*   **Vereinheitlichung:** Die Trigger-Topics wurden standardisiert (`ingestion-requests` für Ingestion, `condition-assessment-jobs` für Zustandserfassung).
*   **Deployment-Update:** Die Cloud Build Trigger (`cloudbuild.ingestion-agent.yaml` etc.) wurden aktualisiert, um exakt auf diese Topics zu hören.

## 4. Pricing Agent Fallback (Google Search Tool Instabilität)

**Problem:**
Der `strategist-agent` (Pricing) stürzte ab oder lieferte Fehler (`400 Bad Request`), wenn er versuchte, das Google Search Tool in Kombination mit Bild-Inputs in der Region `europe-west1` zu nutzen. Dies scheint eine temporäre Einschränkung oder Instabilität der Gemini API in dieser Region zu sein.

**Lösung:**
*   **Fallback-Modus:** Das Google Search Tool wurde vorübergehend deaktiviert.
*   **Internal Knowledge:** Der Agent nutzt nun das "Internal Knowledge" des Modells (Gemini 1.5 Flash), um Preise zu schätzen.
*   **Bild-Reduktion:** Bilder werden nicht mehr direkt an den Pricing-Prompt gesendet, um die Komplexität und Fehleranfälligkeit zu reduzieren. Stattdessen verlässt sich der Agent auf die (sehr präzisen) extrahierten Metadaten aus den vorherigen Schritten (Ingestion & Condition Assessment).
